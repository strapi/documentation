name: Bulk remove AI-generated labels from PRs

on:
  workflow_dispatch:
    inputs:
      state:
        description: "PR state to process (open|closed|all)"
        default: "all"
        required: true
      days:
        description: "Lookback window in days for closed PRs (ignored for open)"
        default: "120"
        required: true
      labels:
        description: "Comma-separated labels to remove (case-insensitive)"
        default: "auto-generated by AI,AI-generated,ai generated,auto generated by ai,generated by ai"
        required: true
      dry_run:
        description: "If true, only logs matches without removing"
        default: "false"
        required: true

permissions:
  contents: read
  pull-requests: write

jobs:
  scrub:
    runs-on: ubuntu-latest
    steps:
      - name: Remove labels from PRs
        uses: actions/github-script@v7
        with:
          script: |
            const state = core.getInput('state');
            const days = parseInt(core.getInput('days'), 10) || 120;
            const dryRun = /^true$/i.test(core.getInput('dry_run'));
            const labels = core.getInput('labels')
              .split(',')
              .map(s => s.trim().toLowerCase())
              .filter(Boolean);

            core.info(`Processing state='${state}', days='${days}', dry_run='${dryRun}', labels=[${labels.join(', ')}]`);

            const per_page = 100;

            async function* iteratePRs(targetState) {
              let page = 1;
              while (true) {
                const { data } = await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: targetState === 'all' ? 'all' : targetState,
                  per_page,
                  page,
                });
                if (!data || data.length === 0) break;
                for (const pr of data) yield pr;
                if (data.length < per_page) break;
                page += 1;
              }
            }

            const cutoff = Date.now() - days * 24 * 3600 * 1000;

            let totalReviewed = 0;
            let totalEdited = 0;
            for await (const pr of iteratePRs(state)) {
              totalReviewed += 1;
              if (state !== 'open') {
                const updatedAt = Date.parse(pr.updated_at || pr.closed_at || pr.merged_at || pr.created_at);
                if (isFinite(updatedAt) && updatedAt < cutoff) continue;
              }

              const labelNames = (pr.labels || []).map(l => (typeof l === 'string' ? l : l.name)).filter(Boolean);
              const present = labelNames.map(n => n.toLowerCase()).filter(n => labels.includes(n));
              if (present.length === 0) continue;

              core.info(`PR #${pr.number} matches [${present.join(', ')}]`);
              if (dryRun) continue;

              for (const name of present) {
                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: pr.number,
                    name,
                  });
                  totalEdited += 1;
                } catch (e) {
                  core.warning(`Failed to remove '${name}' from #${pr.number}: ${e.message}`);
                }
              }
            }

            core.info(`Reviewed PRs: ${totalReviewed} | Labels removed ops: ${totalEdited}`);
            core.setOutput('reviewed', totalReviewed);
            core.setOutput('edited', totalEdited);

